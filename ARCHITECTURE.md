# Smart Parking System - Payment Architecture

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DEVELOPMENT SETUP                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          YOUR COMPUTER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Flutter Web App  â”‚         â”‚ Backend Server   â”‚                 â”‚
â”‚  â”‚ (Chrome Port)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ (Port 5000)      â”‚                 â”‚
â”‚  â”‚ localhost:xxxx   â”‚  HTTP   â”‚ localhost:5000   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                        â”‚                            â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                              â”‚   ngrok Tunnel     â”‚                â”‚
â”‚                              â”‚   Port 5000        â”‚                â”‚
â”‚                              â”‚ (Local Proxy)      â”‚                â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                        â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         INTERNET (Public)              â”‚
                    â”‚                                        â”‚
                    â”‚  HTTPS://xxxx-xxxx-xxxx-xxxx.ngrok.io â”‚
                    â”‚                                        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Safaricom M-Pesa Sandbox API         â”‚
                    â”‚ sandbox.safaricom.co.ke                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“± Payment Flow Sequence

```
User Pays for Parking
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks "Pay" button â”‚  (Flutter Grid Screen)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ POST to /api/mpesa/stkpush
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend receives request â”‚  (Express.js Route)
â”‚ - Phone: +254712345678   â”‚
â”‚ - Amount: 1140.83        â”‚
â”‚ - SlotID: 5              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ Format data
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phone: 254712345678      â”‚  (Formatted)
â”‚ Amount: 1141 (integer)   â”‚  (KES currency)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ Get OAuth token
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /oauth/v1/generate                  â”‚
â”‚ sandbox.safaricom.co.ke                  â”‚
â”‚ Returns: access_token                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ Send STK Push
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /mpesa/stkpush/v1/processrequest   â”‚
â”‚ Payload:                                 â”‚
â”‚ - BusinessShortCode: 174379             â”‚
â”‚ - Amount: 1141                          â”‚
â”‚ - PartyA: 254712345678                  â”‚
â”‚ - CallBackURL: https://xxxx.ngrok.io   â”‚  â† PUBLIC URL
â”‚   /api/mpesa/callback                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ Response (if success)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ResponseCode: 0                          â”‚
â”‚ ResponseDescription: "Accept..."         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                     â”‚
        â–¼ (Immediate response to Flutter)    â–¼ (Async to phone)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Show Success Message:          â”‚   â”‚ User's M-Pesa:  â”‚
â”‚ âœ… "M-Pesa prompt sent..."    â”‚   â”‚ STK Prompt      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ User enters PIN â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚                           â”‚
                        Success Scenario    Failure Scenario
                                â”‚                           â”‚
                                â–¼                           â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ User approvesâ”‚          â”‚ User cancels â”‚
                        â”‚ payment      â”‚          â”‚ or wrong PIN â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                           â”‚
                                â–¼                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Safaricom calls:       â”‚ â”‚ No callback sent  â”‚
                    â”‚ POST /api/mpesa/      â”‚ â”‚ (Payment remains  â”‚
                    â”‚ callback              â”‚ â”‚  in pending)      â”‚
                    â”‚ (via ngrok public URL)â”‚ â”‚                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Backend processes      â”‚
                    â”‚ - Extract receipt      â”‚
                    â”‚ - Extract phone        â”‚
                    â”‚ - Extract amount       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Update DB:             â”‚
                    â”‚ payments.status = paid â”‚
                    â”‚ payments.mpesa_receipt â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Return 200 OK to       â”‚
                    â”‚ Safaricom              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Component Interaction

### Frontend (Flutter)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   grid_screen.dart                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  onClick("Pay") â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                                       â”‚                   â”‚
â”‚                                       â–¼                   â”‚
â”‚                              ApiService.initiateMpesa()   â”‚
â”‚                                       â”‚                   â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                    â”‚  POST /api/mpesa/stkpush           â”‚ â”‚
â”‚                    â”‚  Headers: Content-Type: applicationâ”‚ â”‚
â”‚                    â”‚           /json                     â”‚ â”‚
â”‚                    â”‚  Body: {                           â”‚ â”‚
â”‚                    â”‚    phoneNumber: "+254712345678"    â”‚ â”‚
â”‚                    â”‚    amount: "1140"                  â”‚ â”‚
â”‚                    â”‚    accountReference: "5"           â”‚ â”‚
â”‚                    â”‚    description: "Parking fee..."   â”‚ â”‚
â”‚                    â”‚  }                                 â”‚ â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                       â”‚                   â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚            â”‚                                            â”‚ â”‚
â”‚            â–¼                                            â–¼ â”‚
â”‚      âœ… Success (200)                          âŒ Error (4xx)
â”‚      Show green snackbar                       Show red snackbar
â”‚      "M-Pesa prompt sent"                      "Error details"
â”‚      _refreshSlots()                                      â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Backend (Express.js)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    routes/mpesa.js                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  POST /stkpush                                            â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ Validate input                                        â”‚
â”‚  â”‚  â”œâ”€ phoneNumber? âœ“                                     â”‚
â”‚  â”‚  â”œâ”€ amount? âœ“                                          â”‚
â”‚  â”‚  â””â”€ accountReference? âœ“                                â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ Format phone: "+254712345678" â†’ "254712345678"       â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ getToken()                                            â”‚
â”‚  â”‚  â””â”€ OAuth call to Safaricom (gets access_token)       â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ Create payload                                        â”‚
â”‚  â”‚  â”œâ”€ BusinessShortCode: "174379"                        â”‚
â”‚  â”‚  â”œâ”€ Password: base64(shortcode+passkey+timestamp)      â”‚
â”‚  â”‚  â”œâ”€ Timestamp: "20251120083150"                        â”‚
â”‚  â”‚  â”œâ”€ Amount: 1141 (integer)                             â”‚
â”‚  â”‚  â”œâ”€ PartyA: "254110596134"                             â”‚
â”‚  â”‚  â”œâ”€ CallBackURL: "https://xxxx.ngrok.io/..."          â”‚
â”‚  â”‚  â””â”€ AccountReference: "5"                              â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ Send to Safaricom                                     â”‚
â”‚  â”‚  â””â”€ POST /mpesa/stkpush/v1/processrequest             â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ Get response                                          â”‚
â”‚  â”‚  â”œâ”€ Success? (ResponseCode: 0)                        â”‚
â”‚  â”‚  â””â”€ Error? (Return error details)                     â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ Insert payment record                                 â”‚
â”‚  â”‚  â””â”€ INSERT INTO payments (slot_id, phone, amount)     â”‚
â”‚  â”‚                                                         â”‚
â”‚  â””â”€ Return to frontend                                    â”‚
â”‚                                                             â”‚
â”‚                                                             â”‚
â”‚  POST /callback (Called by Safaricom)                     â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ Receive callback payload                              â”‚
â”‚  â”‚  â””â”€ Contains: receipt, phone, amount, result_code     â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ Check result_code                                     â”‚
â”‚  â”‚  â”œâ”€ 0 = Success                                        â”‚
â”‚  â”‚  â””â”€ != 0 = Failed                                      â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ Update payment record                                 â”‚
â”‚  â”‚  â””â”€ UPDATE payments SET status='paid', receipt='...'  â”‚
â”‚  â”‚                                                         â”‚
â”‚  â””â”€ Return 200 OK to Safaricom                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸŒ ngrok's Role

```
BEFORE ngrok (âŒ Doesn't work):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Your Computer                                           â”‚
â”‚ Backend: http://localhost:5000                          â”‚
â”‚          (Only accessible locally)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Safaricom can't reach this!
            â”‚ (Not publicly accessible)
            â–¼
        âŒ Error: Invalid CallBackURL


AFTER ngrok (âœ… Works):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Your Computer                                           â”‚
â”‚ Backend: http://localhost:5000                          â”‚
â”‚          â†“                                              â”‚
â”‚ ngrok tunnel                                            â”‚
â”‚          â†“                                              â”‚
â”‚ Public URL: https://xxxx-xxxx.ngrok.io                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Safaricom can reach this!
            â”‚ (Public internet address)
            â–¼
        âœ… Callback delivered successfully
```

## ğŸ“Š Data Flow Example

```
Payment Request:
{
  "phoneNumber": "+254712345678",
  "amount": "1140.8333333333333",
  "accountReference": "5",
  "description": "Parking fee for slot 5"
}
         â”‚
         â–¼ (Processing)
{
  "phone": "254712345678",           â† Formatted
  "amount": 1141,                    â† Integer KES
  "accountReference": "5"
}
         â”‚
         â–¼ (Sent to Safaricom)
Response:
{
  "ok": true,
  "data": {
    "ResponseCode": "0",
    "ResponseDescription": "Accept the service request successfully."
  }
}
         â”‚
         â–¼ (Frontend)
Snackbar: âœ… "M-Pesa prompt sent successfully"


Callback (Later):
{
  "Body": {
    "stkCallback": {
      "ResultCode": 0,
      "CallbackMetadata": {
        "Item": [
          {"Name": "MpesaReceiptNumber", "Value": "ABC123"},
          {"Name": "PhoneNumber", "Value": "254712345678"},
          {"Name": "Amount", "Value": 1141}
        ]
      }
    }
  }
}
         â”‚
         â–¼ (Backend processes)
Database Update:
UPDATE payments 
SET status='paid', mpesa_receipt='ABC123' 
WHERE phone='254712345678' AND status='pending'
```

## ğŸ” Security Considerations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            SECURITY FEATURES                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ 1. OAuth Token                                          â”‚
â”‚    - Obtained fresh for each payment                    â”‚
â”‚    - Limited lifetime                                   â”‚
â”‚    - Sent only to Safaricom servers                     â”‚
â”‚                                                         â”‚
â”‚ 2. Password Hashing (for STK Push)                      â”‚
â”‚    - base64(ShortCode + PassKey + Timestamp)            â”‚
â”‚    - Unique per request (timestamp changes)             â”‚
â”‚    - Required by Safaricom API                          â”‚
â”‚                                                         â”‚
â”‚ 3. ngrok Encryption                                     â”‚
â”‚    - HTTPS (https://xxxx.ngrok.io)                      â”‚
â”‚    - All callbacks encrypted in transit                 â”‚
â”‚                                                         â”‚
â”‚ 4. Environment Variables                                â”‚
â”‚    - Secrets in .env, never in code                     â”‚
â”‚    - NGROK_AUTHTOKEN hidden                             â”‚
â”‚    - MPESA credentials not exposed                      â”‚
â”‚                                                         â”‚
â”‚ 5. Database                                             â”‚
â”‚    - Payment records stored with receipt #              â”‚
â”‚    - Status tracking (pending â†’ paid)                   â”‚
â”‚    - Audit trail of transactions                        â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ˆ Scaling Considerations

For production deployment, replace ngrok with:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PRODUCTION DEPLOYMENT                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ Backend Server (AWS EC2, Heroku, etc.)                 â”‚
â”‚ â”‚                                                       â”‚
â”‚ â”œâ”€ Public Domain: parking.example.com                  â”‚
â”‚ â”‚  (DNS + SSL Certificate)                             â”‚
â”‚ â”‚                                                       â”‚
â”‚ â”œâ”€ No ngrok needed                                     â”‚
â”‚ â”‚                                                       â”‚
â”‚ â”œâ”€ Callback URL: https://parking.example.com/          â”‚
â”‚ â”‚                 api/mpesa/callback                   â”‚
â”‚ â”‚                                                       â”‚
â”‚ â”œâ”€ All traffic encrypted (HTTPS)                       â”‚
â”‚ â”‚                                                       â”‚
â”‚ â””â”€ Production Safaricom credentials                    â”‚
â”‚                                                         â”‚
â”‚ Plus:                                                  â”‚
â”‚ - Load balancer                                        â”‚
â”‚ - Auto-scaling                                         â”‚
â”‚ - Database replication                                 â”‚
â”‚ - API rate limiting                                    â”‚
â”‚ - Request logging & monitoring                         â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**This architecture ensures secure, scalable payment processing! ğŸ‰**
